import json
import requests
from dotenv import load_dotenv

from sqlalchemy.orm import Session
from sqlalchemy.exc import IntegrityError
from sqlalchemy import insert

try:
    from backend.DB.db import Database
except ModuleNotFoundError:
    from DB.db import Database


class Extract:
    def __init__(self):
        self.database = Database()
        self.database.open_create_db()
        self.engine = self.database.engine
        self.tables = self.database.tables

    def __query(self, table):
        session = Session(self.engine)
        src_table_obj = self.tables[table]
        results = session.query(src_table_obj).all()
        output = []
        for result in results:
            d = result.__dict__
            d.pop('_sa_instance_state', None)
            output.append(d)
        session.close()
        return output

    def run(self):
        # get sources
        sources = self.__query('sources')

        for source in sources:
            url = source['URL']
            



